server {
  listen 80;
  server_name _;

  root /usr/share/nginx/html;
  index index.html;

  # ------------------------------------------------------------
  # IMPORTANT: empêcher nginx de fabriquer des Location en http://
  # (quand il ajoute un slash, normalise, etc. derrière un proxy)
  # ------------------------------------------------------------
  absolute_redirect off;
  port_in_redirect off;
  server_name_in_redirect off;

  # --- assets statiques (cache long) ---
  location ~* \.(?:js|css|png|jpg|jpeg|gif|webp|ico|svg|woff2?|ttf|eot|map)$ {
    expires 30d;
    add_header Cache-Control "public, max-age=2592000";
    try_files $uri =404;
    access_log off;
  }

  # --- sitemap / robots ---
  location ~* ^/(?:sitemap\.xml|sitemap-[^/]+\.xml|robots\.txt)$ {
    expires 10m;
    add_header Cache-Control "public, max-age=600";
    try_files $uri =404;
  }

  # --- canonicalize /fr -> /fr/ ---
  location = /fr {
    return 301 /fr/;
  }

  # ------------------------------------------------------------
  # SPA fallback par locales connues
  # FIX: NE PAS utiliser $uri/ sinon si le dossier existe sans index.html => 403
  # ------------------------------------------------------------
  location ^~ /fr/      { try_files $uri /fr/index.html; }
  location ^~ /en/      { try_files $uri /en/index.html; }
  location ^~ /es/      { try_files $uri /es/index.html; }
  location ^~ /de/      { try_files $uri /de/index.html; }
  location ^~ /it/      { try_files $uri /it/index.html; }
  location ^~ /nl/      { try_files $uri /nl/index.html; }
  location ^~ /sv/      { try_files $uri /sv/index.html; }
  location ^~ /da/      { try_files $uri /da/index.html; }
  location ^~ /no/      { try_files $uri /no/index.html; }
  location ^~ /fi/      { try_files $uri /fi/index.html; }
  location ^~ /pl/      { try_files $uri /pl/index.html; }
  location ^~ /cs/      { try_files $uri /cs/index.html; }
  location ^~ /sk/      { try_files $uri /sk/index.html; }
  location ^~ /ro/      { try_files $uri /ro/index.html; }
  location ^~ /hu/      { try_files $uri /hu/index.html; }
  location ^~ /tr/      { try_files $uri /tr/index.html; }
  location ^~ /id/      { try_files $uri /id/index.html; }
  location ^~ /vi/      { try_files $uri /vi/index.html; }
  location ^~ /sw/      { try_files $uri /sw/index.html; }
  location ^~ /af/      { try_files $uri /af/index.html; }
  location ^~ /fil/     { try_files $uri /fil/index.html; }
  location ^~ /pt-BR/   { try_files $uri /pt-BR/index.html; }
  location ^~ /pt-PT/   { try_files $uri /pt-PT/index.html; }
  location ^~ /ru/      { try_files $uri /ru/index.html; }
  location ^~ /uk/      { try_files $uri /uk/index.html; }
  location ^~ /bg/      { try_files $uri /bg/index.html; }
  location ^~ /el/      { try_files $uri /el/index.html; }
  location ^~ /ja/      { try_files $uri /ja/index.html; }
  location ^~ /ko/      { try_files $uri /ko/index.html; }
  location ^~ /zh-Hans/ { try_files $uri /zh-Hans/index.html; }

  # --- racine du container : fallback fr ---
  location = / {
    return 302 /fr/;
  }

  # --- tout le reste fallback fr ---
  # (pareil: pas de $uri/ pour éviter un 403 si un dossier existe)
  location / {
    try_files $uri /fr/index.html;
  }
}
