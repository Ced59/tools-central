server {
  listen 80;
  server_name _;

  root /usr/share/nginx/html;
  index index.html;

  # ------------------------------------------------------------
  # IMPORTANT: empêcher nginx de fabriquer des Location en http://
  # (quand il ajoute un slash, normalise, etc. derrière un proxy)
  # ------------------------------------------------------------
  absolute_redirect off;
  port_in_redirect off;
  server_name_in_redirect off;

  # --- assets statiques (cache long) ---
  location ~* \.(?:js|css|png|jpg|jpeg|gif|webp|ico|svg|woff2?|ttf|eot|map)$ {
    expires 30d;
    add_header Cache-Control "public, max-age=2592000";
    try_files $uri =404;
    access_log off;
  }

  # --- sitemap / robots ---
  location ~* ^/(?:sitemap\.xml|sitemap-[^/]+\.xml|robots\.txt)$ {
    expires 10m;
    add_header Cache-Control "public, max-age=600";
    try_files $uri =404;
  }

  # --- canonicalize /fr -> /fr/ ---
  location = /fr {
    return 301 /fr/;
  }

  # --- fallback SPA par locales connues ---
  location ^~ /fr/      { try_files $uri $uri/ /fr/index.html; }
  location ^~ /en/      { try_files $uri $uri/ /en/index.html; }
  location ^~ /es/      { try_files $uri $uri/ /es/index.html; }
  location ^~ /de/      { try_files $uri $uri/ /de/index.html; }
  location ^~ /it/      { try_files $uri $uri/ /it/index.html; }
  location ^~ /nl/      { try_files $uri $uri/ /nl/index.html; }
  location ^~ /sv/      { try_files $uri $uri/ /sv/index.html; }
  location ^~ /da/      { try_files $uri $uri/ /da/index.html; }
  location ^~ /no/      { try_files $uri $uri/ /no/index.html; }
  location ^~ /fi/      { try_files $uri $uri/ /fi/index.html; }
  location ^~ /pl/      { try_files $uri $uri/ /pl/index.html; }
  location ^~ /cs/      { try_files $uri $uri/ /cs/index.html; }
  location ^~ /sk/      { try_files $uri $uri/ /sk/index.html; }
  location ^~ /ro/      { try_files $uri $uri/ /ro/index.html; }
  location ^~ /hu/      { try_files $uri $uri/ /hu/index.html; }
  location ^~ /tr/      { try_files $uri $uri/ /tr/index.html; }
  location ^~ /id/      { try_files $uri $uri/ /id/index.html; }
  location ^~ /vi/      { try_files $uri $uri/ /vi/index.html; }
  location ^~ /sw/      { try_files $uri $uri/ /sw/index.html; }
  location ^~ /af/      { try_files $uri $uri/ /af/index.html; }
  location ^~ /fil/     { try_files $uri $uri/ /fil/index.html; }
  location ^~ /pt-BR/   { try_files $uri $uri/ /pt-BR/index.html; }
  location ^~ /pt-PT/   { try_files $uri $uri/ /pt-PT/index.html; }
  location ^~ /ru/      { try_files $uri $uri/ /ru/index.html; }
  location ^~ /uk/      { try_files $uri $uri/ /uk/index.html; }
  location ^~ /bg/      { try_files $uri $uri/ /bg/index.html; }
  location ^~ /el/      { try_files $uri $uri/ /el/index.html; }
  location ^~ /ja/      { try_files $uri $uri/ /ja/index.html; }
  location ^~ /ko/      { try_files $uri $uri/ /ko/index.html; }
  location ^~ /zh-Hans/ { try_files $uri $uri/ /zh-Hans/index.html; }

  # --- racine du container : fallback fr ---
  location = / {
    return 302 /fr/;
  }

  # --- tout le reste fallback fr ---
  location / {
    try_files $uri $uri/ /fr/index.html;
  }
}
