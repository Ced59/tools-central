<app-pdf-tool-shell
  [ui]="uiShell"
  icon="pi pi-file-pdf"
  [title]="ui.title"
  [subtitle]="ui.subtitle"
  [backLink]="backLink"
  [status]="status()"
  [fileName]="fileName()"
  [fileSize]="fileSize()"
  [tipMessage]="tipMessage()"
  [errorMessage]="shellErrorMessage()"
  [stats]="statsCards()"
  [totalCount]="counts().all"
  [filteredCount]="counts().shown"
  [filterControl]="form.controls.filter"
  [jsonText]="jsonText()"
  [showResults]="status() === 'ready'"
  (fileSelected)="onFileSelected($event)"
  (reset)="reset()"
  (copy)="copyJson()"
  (download)="downloadJson()"
>
  <!-- ✅ Liste gauche -->
  <div leftList>
    @if (filteredFields().length === 0) {
      <div class="empty-box">
        <i class="pi pi-search" aria-hidden="true"></i>
        <span i18n="@@pdf_fields_no_match">Aucun champ ne correspond au filtre.</span>
      </div>
    } @else {
      @for (f of filteredFields(); track f.Name) {
        <div class="field-card">
          <div class="field-card-header">
            <div class="field-card-title">
              <div class="field-name">{{ f.Name }}</div>
              <p-tag severity="info" [value]="f.Type"></p-tag>
            </div>

            <div class="field-card-page">
              <span class="muted" i18n="@@pdf_fields_page">Page</span>
              <span class="mono">{{ f.Widget.Page }}</span>
            </div>
          </div>

          <div class="field-card-value">
            <div class="muted" i18n="@@pdf_fields_value_label">Valeur</div>
            <p-tag severity="contrast" [value]="JSON.stringify(f.Value)"></p-tag>
          </div>

          @if (showAdvanced()) {
            <div class="divider"></div>

            <div class="field-card-advanced">
              <div class="adv-kv">
                <div class="adv-k">PartialName</div>
                <div class="adv-v mono">{{ f.PartialName }}</div>
              </div>

              <div class="adv-kv">
                <div class="adv-k">DefaultValue</div>
                <div class="adv-v mono">{{ f.DefaultValue }}</div>
              </div>

              <div class="adv-kv">
                <div class="adv-k">Justification</div>
                <div class="adv-v mono">{{ f.Justification }}</div>
              </div>

              <div class="adv-kv">
                <div class="adv-k">MaxLen</div>
                <div class="adv-v mono">{{ f.MaxLen }}</div>
              </div>

              <div class="adv-kv">
                <div class="adv-k">Flags</div>
                <div class="adv-v mono">
                  ReadOnly={{ f.Flags.ReadOnly }}, Required={{ f.Flags.Required }}
                </div>
              </div>

              <div class="adv-kv">
                <div class="adv-k">Tooltip</div>
                <div class="adv-v mono">{{ f.Tooltip }}</div>
              </div>

              <div class="adv-kv">
                <div class="adv-k">Rect</div>
                <div class="adv-v mono">{{ JSON.stringify(f.Widget.Rect) }}</div>
              </div>

              @if (f.Extra) {
                <div class="adv-kv">
                  <div class="adv-k">Extra.FullyQualifiedName</div>
                  <div class="adv-v mono">{{ f.Extra.FullyQualifiedName }}</div>
                </div>

                <div class="adv-kv">
                  <div class="adv-k">Extra.FieldTypeRaw</div>
                  <div class="adv-v mono">{{ JSON.stringify(f.Extra.FieldTypeRaw) }}</div>
                </div>

                <div class="adv-kv">
                  <div class="adv-k">Extra.Ff</div>
                  <div class="adv-v mono">{{ JSON.stringify(f.Extra.Ff) }}</div>
                </div>

                <div class="adv-kv">
                  <div class="adv-k">Extra.Q</div>
                  <div class="adv-v mono">{{ JSON.stringify(f.Extra.Q) }}</div>
                </div>

                <div class="adv-kv">
                  <div class="adv-k">Extra.DA</div>
                  <div class="adv-v mono">{{ JSON.stringify(f.Extra.DA) }}</div>
                </div>

                <div class="adv-kv">
                  <div class="adv-k">Extra.KidsCount</div>
                  <div class="adv-v mono">{{ JSON.stringify(f.Extra.KidsCount) }}</div>
                </div>

                @if (f.Extra.Options && f.Extra.Options.length) {
                  <div class="adv-kv">
                    <div class="adv-k">Extra.Options</div>
                    <div class="adv-v mono">{{ f.Extra.Options.join(', ') }}</div>
                  </div>
                }

                @if (f.Extra.ExportDiagnostics) {
                  <div class="adv-kv">
                    <div class="adv-k">Extra.ExportDiagnostics</div>
                    <div class="adv-v mono">
                      HasAcroFieldDict={{ f.Extra.ExportDiagnostics.HasAcroFieldDict }},
                      HasKids={{ f.Extra.ExportDiagnostics.HasKids }},
                      HasRect={{ f.Extra.ExportDiagnostics.HasRect }},
                      HasPageRef={{ f.Extra.ExportDiagnostics.HasPageRef }}
                    </div>
                  </div>
                }
              }
            </div>
          }
        </div>
      }
    }
  </div>

  <!-- ✅ Options droite (en bas du JSON panel) -->
  <div rightOptions>
    <div class="actions" style="flex-direction: column; align-items: flex-start;">
      <p-button
        type="button"
        icon="pi pi-align-left"
        [severity]="pretty() ? 'help' : 'secondary'"
        [text]="!pretty()"
        (onClick)="togglePretty()"
        [label]="prettyLabel()"
      ></p-button>

      <p-button
        type="button"
        icon="pi pi-filter"
        [severity]="includeEmpty() ? 'help' : 'secondary'"
        [text]="!includeEmpty()"
        (onClick)="toggleIncludeEmpty()"
        [label]="emptyLabel()"
      ></p-button>

      <p-button
        type="button"
        icon="pi pi-sliders-h"
        [severity]="showAdvanced() ? 'help' : 'secondary'"
        [text]="!showAdvanced()"
        (onClick)="toggleAdvanced()"
        [label]="advancedLabel()"
      ></p-button>
    </div>

    @if (status() === 'ready' && fields().length === 0) {
      <div class="tip-box" role="status">
        <i class="pi pi-info-circle" aria-hidden="true"></i>
        <span i18n="@@pdf_fields_no_fields">
          Aucun champ détecté. Le PDF ne contient peut-être pas d'AcroForm (ou utilise XFA).
        </span>
      </div>
    }
  </div>
</app-pdf-tool-shell>

<!-- ✅ On garde la section pédagogique, hors shell -->
<div class="container tool-content">
  <div class="tool-card">
    <div class="card-header centered">
      <h2 i18n="@@pdf_fields_about_title">À savoir</h2>
      <p i18n="@@pdf_fields_about_sub">
        L'extraction est faite côté navigateur et fonctionne surtout pour les formulaires AcroForm.
      </p>
    </div>

    <div class="explain-content">
      <ul class="steps-list">
        <li i18n="@@pdf_fields_about_1">Le PDF reste local : aucun upload, aucun stockage serveur.</li>
        <li i18n="@@pdf_fields_about_2">Le JSON inclut les champs extraits et un objet Extra (best-effort).</li>
        <li i18n="@@pdf_fields_about_3">
          Certains PDF administratifs utilisent XFA : dans ce cas, les champs peuvent être invisibles côté navigateur.
        </li>
      </ul>

      <div class="tip-box">
        <i class="pi pi-info-circle"></i>
        <span i18n="@@pdf_fields_page_minus1_help">
          Si <code>Page = -1</code>, cela signifie que la métadonnée permettant de relier le champ à une page
          n'est pas disponible (ou pas exploitable) côté navigateur.
        </span>
      </div>

      <div class="tip-box">
        <i class="pi pi-code"></i>
        <span class="mono">
          Exemple :
          {{ '{' }} "Name": "NOM_PM_1", "Type": "e_text", "Widget": {{ '{' }} "Page": 1 {{ '}' }},
          "Extra": {{ '{' }} ... {{ '}' }} {{ '}' }}
        </span>
      </div>
    </div>
  </div>
</div>
